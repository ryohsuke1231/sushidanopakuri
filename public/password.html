<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アクセス認証</title>
    <style>
        /* (スタイル部分は前回と同じ) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a; /* 濃いグレーの背景 */
            color: #f0f2f5;           /* 明るい文字色 */
            display: flex;
            align-items: center;      /* 垂直方向の中央揃え */
            justify-content: center;   /* 水平方向の中央揃え */
            min-height: 100vh;        /* 画面全体の高さ */
            margin: 0;
        }
        #authForm {
            background-color: #2a2a2a; /* 少し明るいグレーのカード */
            padding: 2rem;
            border-radius: 12px;      /* 角を丸くする */
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); /* 濃い影 */
            max-width: 400px;
            width: 90%;
            box-sizing: border-box;
            text-align: center; /* 中身を中央揃えに */
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #ffffff;
            margin-top: 0;
            margin-bottom: 2rem; /* PIN入力とのマージン */
            font-weight: 600;
            display: flex;
            justify-content: center;
        }
        #pin-container {
            display: flex;
            justify-content: center; /* ボックスを中央に */
            gap: 10px;               /* ボックス間の隙間 */
            margin-bottom: 0rem;
        }
        .pin-input {
            width: 50px;
            height: 60px;
            font-size: 2rem;
            text-align: center;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 8px;
            /* スピナー（上下矢印）を非表示 */
            -moz-appearance: textfield;
            appearance: none;
        }
        .pin-input::-webkit-outer-spin-button,
        .pin-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .pin-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.3);
            outline: none;
        }
        button {
            width: 100%;
            padding: 0.85rem;
            background-color: #007bff; /* メインの色（青） */
            color: white;
            border: none;
            border-radius: 50px;      /* ★ 円形（ピル型）に */
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:active {
            transform: scale(0.98); /* クリック時に少し小さく */
        }
        #message {
            color: #ff4444; /* エラーメッセージの色 */
            font-size: 0.9rem;
            padding: 1rem;
            display: flex;
        }
    </style>
</head>
<body>

    <div id="authForm">
        <h1>なんとなく認証</h1>

        <form id="authFormElement" action="javascript:void(0);">

            <div id="pin-container">
                <input type="text" class="pin-input" maxlength="1" inputmode="numeric" required>
                <input type="text" class="pin-input" maxlength="1" inputmode="numeric" required>
                <input type="text" class="pin-input" maxlength="1" inputmode="numeric" required>
                <input type="text" class="pin-input" maxlength="1" inputmode="numeric" required>
            </div>
            <span id="message"></span>

            <button type="submit">認証</button>
        </form>
    </div>

    <script>
        /**
         * ユーザーの入力値をBasic認証として /api/login へのアクセスを試みる
         */
        async function attemptAuth() {
            const inputs = document.querySelectorAll('.pin-input');
            let password = '';
            inputs.forEach(input => password += input.value);

            if (password.length !== 4) return;

            // ★ 修正: Python側のデフォルト (admin) に合わせる
            const username = 'admin'; 
            const credentials = btoa(`${username}:${password}`);

            try {
                // ★ 修正: method: 'POST' を明記
                const res = await fetch('/api/login', {
                    method: 'POST', // POSTメソッドを指定
                    headers: {
                        'Authorization': `Basic ${credentials}`
                    }
                });

                if (res.ok) {
                    // 認証成功 (サーバーがCookieをセットした)
                    // → index.html に遷移する
                    window.location.href = '/index.html';
                } else {
                    // 認証失敗
                    // ★ 修正: 失敗したら入力欄をクリアする処理を追加
                    inputs.forEach(input => input.value = '');
                    if (inputs.length > 0) inputs[0].focus(); // 最初の入力欄にフォーカスを戻す

                    // エラーメッセージを表示
                    document.getElementById('message').textContent = '認証に失敗しました。再度入力してください。';

                    // (リダイレクト方式でもOKです)
                    // window.location.href = '/password.html?message=' + encodeURIComponent('認証に失敗しました。再度入力してください。');
                }
            } catch (err) {
                console.error("通信エラー:", err);
                document.getElementById('message').textContent = '通信エラーが発生しました。';
            }
        }


        // --- ページ読み込み完了後に実行するスクリプト ---
        document.addEventListener('DOMContentLoaded', () => {
            const queryString = window.location.search;
            const params = new URLSearchParams(queryString);
            const message = params.get('message');
            document.getElementById('message').textContent = message || '';

            // Enterキー(Submit)で認証を実行
            const form = document.getElementById('authFormElement');
            form.addEventListener('submit', (event) => {
                event.preventDefault();  
                attemptAuth();        
            });

            // --- PIN入力の制御 ---
            const pinInputs = document.querySelectorAll('.pin-input');

            pinInputs.forEach((input, index) => {

                // --- 1. 文字が入力された時の処理 ---
                input.addEventListener('input', () => {
                    // 数字以外の文字を削除
                    input.value = input.value.replace(/[^0-9]/g, '');

                    // 1秒後に隠す処理
                    if (input.dataset.timerId) {
                        clearTimeout(input.dataset.timerId);
                    }
                    input.type = 'text'; 
                    input.dataset.timerId = setTimeout(() => {
                        input.type = 'password';
                        input.dataset.timerId = null; 
                    }, 1000); 

                    // 自動フォーカス移動
                    if (input.value.length === 1 && index < pinInputs.length - 1) {
                        pinInputs[index + 1].focus();
                    }
                    // (前の入力欄を隠す処理 - これは 'input' ではなく 'focus' や 'blur' で管理する方がシンプルかもしれません)
                    if (input.value.length === 1 && index - 1 >= 0) {
                         pinInputs[index - 1].type = 'password';
                    }
                });

                // --- 2. キーが押された時の処理 (バックスペース) ---
                input.addEventListener('keydown', (event) => {
                    if (event.key === 'Backspace') {
                        input.type = 'text'; // 入力のために表示

                        // (既存のフォーカス移動)
                        if (input.value.length === 0 && index > 0) {
                            pinInputs[index - 1].focus();
                        }
                    }
                });

                // --- 3. フォーカスが当たった時の処理 ---
                input.addEventListener('focus', () => {
                    input.type = 'text';
                });

                // --- 4. フォーカスが外れた時の処理 ---
                input.addEventListener('blur', () => {
                    // ★★★ 修正箇所 ★★★
                    // 未定義の 'timerId' ではなく 'input.dataset.timerId' を参照する
                    if (input.dataset.timerId) {
                        clearTimeout(input.dataset.timerId); 
                        input.dataset.timerId = null; // タイマーIDをクリア
                    }
                    input.type = 'password'; // フォーカスが外れたら即座に隠す
                });
            });

            // ページ読み込み時に最初のボックスに自動でフォーカスする
            if (pinInputs.length > 0) {
                pinInputs[0].focus();
            }
        });
    </script>
</body>
</html>